<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>富士トライアスロン2024 結果ヴィジュアライザ</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script>
		const file = 'data/result.json';

		const focus_id = ['4026', '5081'];

		const g = {};

		const clear = () => {
			if (g.chart) {
				g.chart.destroy();
				g.chart = null;
			}
		};

		const draw = (key) => {
			clear();

			const key_sec = key + '_sec';

			const valid_sec = g.data.map(x => x[key_sec]).filter(x => x);
			const min = Math.min(...valid_sec);
			const max = Math.max(...valid_sec);

			const accumulate = Array(max - min).fill(0)
				.map((_, i) => min + i)
				.map(x => {
					return {
						x,
						y: valid_sec.filter(t => t < x).length,
					};
				});
			const accumulate_ratio = accumulate
				.map(({ x, y }) => ({ x, y: y / valid_sec.length * 100 }));

			const data = {
				datasets: [{
					label: '全体累積分布',
					type: 'line',
					showLine: true,
					pointRadius: 0,
					pointHitRadius: 0,
					data: accumulate_ratio,
					// backgroundColor: 'rgb(000, 111, 222)',
					order: 0,
				}, ...focus_id.map((id, i) => {
					const d = g.data.find(data => data.number === id);
					const x = d[key_sec];
					return {
						label: d.given_name + ' ' + d.family_name,
						data: [{ x, y: accumulate_ratio.find(n => n.x === x).y, tag: d }],
						order: i + 1,
					};
				})],
			};

			g.chart = new Chart(g.context, {
				type: 'scatter',
				data,
				options: {
					scales: {
						x: {
							type: 'linear',
							position: 'bottom',
							min, max,
						},
						y: {
							type: 'linear',
							position: 'left',
							min: 0,
							max: 100,
							ticks: {
								stepSize: 10,
							},
						}
					},
					plugins: {
						tooltip: {
							callbacks: {
								label: (items, data) => {
									const d = items.raw.tag;
									const time = d[key];
									return `${d.given_name}${d.family_name} ${time}, 上位${items.raw.y.toString().substring(0, 4)}%`
								},
							}
						}
					}
				}
			})
		}

		window.addEventListener('load', () => {
			g.context = document.querySelector('#chart');

			['record', 'swim', 'bike', 'split', 'run'].forEach(id => {
				const button = document.querySelector('#' + id);
				button.addEventListener('click', () => {
					draw(button.id);
				});
			})

			fetch(file)
				.then(res => res.json())
				.then(json => g.data = json)
				.then(json => draw('record'));
		}, { once: true });
	</script>

	<style>
	</style>
</head>

<body>
	<h1>富士トライアスロン2024</h1>
	<canvas id="chart"></canvas>

	<button id="record">総合</button>
	<button id="swim">スイム</button>
	<button id="bike">バイク</button>
	<button id="split">スプリット</button>
	<button id="run">ラン</button>
</body>

</html>